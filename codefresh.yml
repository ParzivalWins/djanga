version: '1.0'

steps:
  build-djanga:
    type: build
    image-name: noamt/djanga
    tag: ${{CF_SHORT_REVISION}}
  
  #cf-comp:
  #  type: composition
  #  composition:
  #    version: '2'
  #    services:
  #      db:
  #        image: postgres
  #  composition-candidates:
  #    web:
  #        image: 'noamt/djanga:master'
  #        command: bash -c 'exit 1'
  #        ports:
  #          - '8000'
  #        links:
  #          - db
  
  deployment:
  image: alpine:latest
  commands: 
     - >- 
     sh -c  "[ ${{CF_BRANCH}} == feature/codefresh ] &&
     aws configure set aws_access_key_id ${{ACCESS_KEY_ID}} &&
     aws configure set aws_secret_access_key ${{SECRET_ACCESS_KEY_ID}} &&
     aws configure set region ${{REGION}} &&
     aws elasticbeanstalk update-environment --environment-name apartments-api-develop --version-label v0.1.${{CF_SHORT_REVISION}}"


  
  push-dockerhub:
    type: push
    candidate: ${{build-djanga}}
